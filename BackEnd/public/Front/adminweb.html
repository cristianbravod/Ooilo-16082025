<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurante - Panel de Control</title>
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --danger-color: #dc3545; --warning-color: #ffc107; --info-color: #17a2b8;
            --light-color: #f8f9fa; --dark-color: #343a40; --white-color: #fff;
            --font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;
            --border-radius: 8px; --shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        body { font-family: var(--font-family); margin: 0; background-color: var(--light-color); color: var(--dark-color); }
        .hidden { display: none !important; }
        #login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: var(--dark-color);}
        .login-card { background: var(--white-color); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; }
        .login-title { font-size: 1.8rem; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        .form-input { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: var(--border-radius); }
        .btn { padding: 0.8rem 1.5rem; border: none; border-radius: var(--border-radius); cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
        .btn-success { background-color: var(--success-color); color: var(--white-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--white-color); }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }
        .error-message { color: var(--danger-color); margin-top: 0.5rem; }
        #app { min-height: 100vh; }
        .header { background: var(--dark-color); color: var(--white-color); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .header-left .logo { font-size: 1.5rem; font-weight: bold; }
        .header-right { display: flex; align-items: center; gap: 1.5rem; }
        #user-info .role { text-transform: capitalize; color: #ccc; font-size: 0.9rem; }
        .logout-btn { background: var(--danger-color); color: var(--white-color); }
        .main-content { display: flex; }
        .sidebar { background: var(--white-color); width: 250px; min-height: calc(100vh - 70px); padding: 1.5rem; box-shadow: var(--shadow); }
        .nav-menu .nav-item { display: block; padding: 1rem; margin-bottom: 0.5rem; border-radius: var(--border-radius); text-decoration: none; color: var(--dark-color); font-weight: 500; }
        .nav-menu .nav-item:hover { background-color: #e9ecef; }
        .nav-menu .nav-item.active { background-color: var(--primary-color); color: var(--white-color); }
        .content-area { flex-grow: 1; padding: 2rem; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
        .order-card, .stat-card, .table-card { background: var(--white-color); border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .order-card { border-left: 5px solid; display: flex; flex-direction: column; }
        .order-card.pendiente, .order-card.confirmada { border-left-color: var(--warning-color); }
        .order-card.preparando { border-left-color: var(--info-color); }
        .order-card.lista { border-left-color: var(--success-color); }
        .order-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .order-mesa { font-size: 1.2rem; font-weight: bold; }
        .order-time { font-size: 0.9rem; color: #666; }
        .order-items { padding: 1rem; flex-grow: 1; }
        .order-item { padding: 0.5rem 0; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center; }
        .order-item:last-child { border-bottom: none; }
        .item-info { flex-grow: 1; }
        .item-name { font-weight: 500; }
        .item-obs { font-size: 0.85rem; color: #777; padding-left: 1rem; }
        .item-actions { display: flex; gap: 0.5rem; }
        .order-status-actions { padding: 1rem; background-color: #f8f9fa; display: flex; gap: 0.5rem; justify-content: flex-end; border-top: 1px solid #eee; }
        .stat-card { padding: 1.5rem; text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: var(--primary-color); }
        .stat-label { font-size: 1rem; color: var(--secondary-color); }
        .table-card { padding: 1.5rem; text-align: center; border-top: 5px solid; }
        .table-card.disponible { border-top-color: var(--success-color); }
        .table-card.ocupada { border-top-color: var(--danger-color); }
        .table-card.limpieza { border-top-color: var(--warning-color); }
        .table-name { font-size: 1.5rem; font-weight: bold; }
        .table-status { text-transform: capitalize; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1 class="login-title">Iniciar Sesi√≥n</h1>
            <form id="login-form">
                <div class="form-group"><label for="email">Email</label><input type="email" id="email" class="form-input" required value="admin@restaurante.com"></div>
                <div class="form-group"><label for="password">Contrase√±a</label><input type="password" id="password" class="form-input" required value="admin123"></div>
                <button type="submit" class="btn btn-primary" id="login-btn">Entrar</button>
                <div id="login-error" class="error-message"></div>
            </form>
        </div>
    </div>

    <div id="app" class="hidden">
        <header class="header">
            <div class="header-left"><span class="logo">üçΩÔ∏è Admin Panel</span></div>
            <div class="header-right">
                <div id="user-info"><span id="user-name"></span><div class="role" id="user-role"></div></div>
                <button class="logout-btn" onclick="logout()">Salir</button>
            </div>
        </header>
        <div class="main-content">
            <aside class="sidebar">
                <nav id="nav-menu" class="nav-menu"></nav>
            </aside>
            <main class="content-area">
                <section id="cocina-section" class="content-section">
                    <h2>üë®‚Äçüç≥ Panel de Cocina</h2>
                    <div style="margin-bottom: 1rem;"><button class="btn btn-primary" onclick="refreshKitchenOrders()">üîÑ Actualizar</button></div>
                    <div id="kitchen-orders" class="grid-container"></div>
                </section>
                <section id="mesas-section" class="content-section">
                    <h2>ü™ë Gesti√≥n de Mesas</h2>
                    <div style="margin-bottom: 1rem;"><button class="btn btn-primary" onclick="refreshTablesView()">üîÑ Actualizar</button></div>
                    <div id="tables-grid" class="grid-container"></div>
                </section>
                <section id="informes-section" class="content-section">
                    <h2>üìä Informes y Estad√≠sticas</h2>
                    <div style="margin-bottom: 1rem;"><button class="btn btn-primary" onclick="refreshReportsView()">üîÑ Actualizar</button></div>
                    <div id="reports-grid" class="grid-container"></div>
                </section>
            </main>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. DECLARACIONES Y CONFIGURACI√ìN ---
    const API_BASE_URL = 'http://200.54.216.197:3000/api';
    let currentUser = null;
    let authToken = null;

    const loginForm = document.getElementById('login-form');
    const appContainer = document.getElementById('app');
    const loginScreen = document.getElementById('login-screen');
    const navMenu = document.getElementById('nav-menu');

    const ROLE_PERMISSIONS = {
        admin: ['cocina', 'mesas', 'informes'],
        chef: ['cocina'],
        cocina: ['cocina'],
        mesero: ['mesas']
    };

    // La definici√≥n de MODULES depende de las funciones de refresh, por eso se declara aqu√≠ y se define en initializeApp
    let MODULES;

    // --- 2. FUNCIONES PRINCIPALES (API, RENDER, ETC) ---

    async function apiRequest(endpoint, options = {}) {
        const url = `${API_BASE_URL}${endpoint}`;
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
        try {
            const response = await fetch(url, { ...options, headers });
            if (!response.ok) {
                const err = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(err.message || `Error ${response.status}`);
            }
            const text = await response.text();
            return text ? JSON.parse(text) : { success: true };
        } catch (error) {
            console.error(`Error en API request a ${endpoint}:`, error);
            throw error;
        }
    }

    function renderOrderCard(order, container) {
        const card = document.createElement('div');
        card.className = `order-card ${order.estado}`;
        const timeDiff = Math.floor((Date.now() - new Date(order.fecha_creacion).getTime()) / 60000);
        card.innerHTML = `
            <div class="order-header"><span class="order-mesa">${order.mesa}</span><span class="order-time">Hace ${timeDiff} min</span></div>
            <div class="order-items">
                ${(order.items || []).map(item => `
                    <div class="order-item">
                        <div class="item-info">
                            <span class="item-name">${item.cantidad}x ${item.nombre}</span>
                            ${item.instrucciones_especiales ? `<div class="item-obs">Obs: ${item.instrucciones_especiales}</div>` : ''}
                        </div>
                        <div class="item-actions">${getItemActions(order.id, item)}</div>
                    </div>`).join('')}
            </div>
            <div class="order-status-actions">${getOrderActions(order)}</div>`;
        container.appendChild(card);
    }

    function getItemActions(orderId, item) {
        const itemState = item.estado || 'pendiente';
        if (itemState === 'lista' || itemState === 'listo') return '<span>‚úÖ</span>';
        const nextState = itemState === 'pendiente' ? 'preparando' : 'lista';
        const buttonText = itemState === 'pendiente' ? 'üî• Preparar' : '‚úÖ Listo';
        return `<button class="btn btn-primary btn-sm" onclick="changeItemStatus(${orderId}, ${item.id}, '${nextState}')">${buttonText}</button>`;
    }

    function getOrderActions(order) {
        const orderState = order.estado;
        if (orderState === 'pendiente' || orderState === 'confirmada') {
            return `<button class="btn btn-warning" onclick="updateOrderStatus(${order.id}, 'preparando')">üî• Empezar Orden</button>`;
        }
        if (orderState === 'preparando') {
            return `<button class="btn btn-success" onclick="updateOrderStatus(${order.id}, 'lista')">‚úÖ Orden Lista</button>`;
        }
        return `<strong>Estado:</strong> ${orderState}`;
    }

    async function refreshKitchenOrders() {
        const container = document.getElementById('kitchen-orders');
        container.innerHTML = '<p>Cargando √≥rdenes...</p>';
        try {
            const data = await apiRequest('/ordenes/activas');
            const orders = data.ordenes || [];
            container.innerHTML = '';
            if (orders.length === 0) {
                container.innerHTML = '<p>No hay pedidos activos.</p>';
                return;
            }
            orders.forEach(order => renderOrderCard(order, container));
        } catch (error) {
            container.innerHTML = `<p class="error-message">Error al cargar √≥rdenes: ${error.message}</p>`;
        }
    }

    async function refreshTablesView() {
        const container = document.getElementById('tables-grid');
        container.innerHTML = '<p>Cargando mesas...</p>';
        try {
            const tables = await apiRequest('/mesas');
            container.innerHTML = '';
            if (!tables || tables.length === 0) {
                container.innerHTML = '<p>No hay mesas configuradas.</p>';
                return;
            }
            tables.forEach(table => {
                const card = document.createElement('div');
                card.className = `table-card ${table.estado}`;
                card.innerHTML = `<div class="table-name">${table.nombre}</div><div class="table-status">${table.estado}</div>`;
                container.appendChild(card);
            });
        } catch (error) {
            container.innerHTML = `<p class="error-message">Error al cargar mesas: ${error.message}</p>`;
        }
    }

    async function refreshReportsView() {
        const container = document.getElementById('reports-grid');
        container.innerHTML = '<p>Cargando informes...</p>';
        try {
            const data = await apiRequest('/reportes/dashboard');
            container.innerHTML = '';
            if (!data.success) throw new Error(data.message);
            const stats = data.estadisticas;
            container.innerHTML = `
                <div class="stat-card"><div class="stat-value">${stats.periodo.ordenes}</div><div class="stat-label">√ìrdenes (Hoy)</div></div>
                <div class="stat-card"><div class="stat-value">$${stats.periodo.ingresos.toFixed(0)}</div><div class="stat-label">Ingresos (Hoy)</div></div>
                <div class="stat-card"><div class="stat-value">${stats.general.ordenes_pendientes}</div><div class="stat-label">√ìrdenes Pendientes</div></div>
                <div class="stat-card"><div class="stat-value">${stats.general.items_activos}</div><div class="stat-label">Items Activos en Men√∫</div></div>
            `;
        } catch (error) {
            container.innerHTML = `<p class="error-message">Error al cargar informes: ${error.message}</p>`;
        }
    }

    // --- 3. FUNCIONES DE SETUP Y MANEJO DE ESTADO ---

    function setupNavigation() {
        if (!currentUser || !currentUser.rol) { logout(); return; }

        // Se define MODULES aqu√≠ porque necesita las funciones de refresh
        MODULES = {
            cocina: { label: 'üë®‚Äçüç≥ Cocina', section: 'cocina-section', init: refreshKitchenOrders },
            mesas: { label: 'ü™ë Mesas', section: 'mesas-section', init: refreshTablesView },
            informes: { label: 'üìä Informes', section: 'informes-section', init: refreshReportsView },
        };

        const permissions = ROLE_PERMISSIONS[currentUser.rol] || [];
        navMenu.innerHTML = '';
        permissions.forEach(key => {
            const mod = MODULES[key];
            if (mod) {
                const navItem = document.createElement('a');
                navItem.href = '#';
                navItem.className = 'nav-item';
                navItem.textContent = mod.label;
                navItem.dataset.section = mod.section;
                navMenu.appendChild(navItem);
            }
        });
        navMenu.addEventListener('click', (e) => {
            if (e.target.classList.contains('nav-item')) {
                e.preventDefault();
                showSection(e.target.dataset.section);
            }
        });
        if (permissions.length > 0) {
            showSection(MODULES[permissions[0]].section);
        }
    }

    function showSection(sectionId) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        const activeSection = document.getElementById(sectionId);
        if(activeSection) activeSection.classList.add('active');

        document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
        const moduleKey = Object.keys(MODULES).find(key => MODULES[key].section === sectionId);
        if(moduleKey && MODULES[moduleKey].init) MODULES[moduleKey].init();
    }

    window.changeItemStatus = async function(orderId, itemId, newStatus) {
        try {
            await apiRequest(`/ordenes/${orderId}/items/${itemId}/estado`, { method: 'PATCH', body: JSON.stringify({ estado: newStatus }) });
            refreshKitchenOrders();
        } catch (error) { alert(`Error al actualizar item: ${error.message}`); }
    }

    window.updateOrderStatus = async function(orderId, newStatus) {
        try {
            await apiRequest(`/ordenes/${orderId}/estado`, { method: 'PATCH', body: JSON.stringify({ estado: newStatus }) });
            refreshKitchenOrders();
        } catch (error) { alert(`Error al actualizar orden: ${error.message}`); }
    }

    function initializeApp() {
        const token = localStorage.getItem('authToken');
        const userJSON = localStorage.getItem('currentUser');
        if (token && userJSON) {
            authToken = token;
            try {
                currentUser = JSON.parse(userJSON);
                if (!currentUser) throw new Error("Datos de usuario corruptos");
                appContainer.classList.remove('hidden');
                loginScreen.classList.add('hidden');
                document.getElementById('user-name').textContent = currentUser.nombre;
                document.getElementById('user-role').textContent = currentUser.rol;
                setupNavigation();
            } catch(e) {
                logout();
            }
        } else {
            appContainer.classList.add('hidden');
            loginScreen.classList.remove('hidden');
        }
    }

    // --- 4. INICIALIZACI√ìN ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        document.getElementById('login-error').textContent = '';
        try {
            await login(document.getElementById('email').value, document.getElementById('password').value);
            initializeApp();
        } catch (error) {
            document.getElementById('login-error').textContent = `Error: ${error.message}`;
        }
    });

    initializeApp();
});
</script>
</body>
</html>
